import React, { useState, useRef, useEffect } from 'react';
// 導入 AlertCircle (帶圓圈的感嘆號) 圖示用於備註
import { Calendar, CheckSquare, Home, Plane, Droplets, MapPin, Utensils, ShoppingBag, Camera, Train, Coffee, Thermometer, Sun, AlertCircle } from 'lucide-react';

// --- 擴充資料 ---
const itineraryData = [
  {
    dayId: "day0",
    dateNum: "10",
    dayName: "FRI",
    fullDate: "1/10",
    title: "出發準備", 
    events: [
      { time: "19:00", title: "溫暖的家", type: "HOME", icon: Home, desc: "確認行李、護照是否帶齊，準備出發！", color: "border-gray-400 text-gray-600" },
      { time: "23:00", title: "前往桃園機場 T1", type: "TRANSPORT", icon: Train, desc: "搭乘交通工具前往機場，準備辦理登機。", color: "border-blue-400 text-blue-600" },
    ]
  },
  {
    dayId: "day1",
    dateNum: "11",
    dayName: "SAT",
    fullDate: "1/11",
    title: "紅眼抵達", 
    events: [
      { time: "02:25", title: "MM620 飛往東京", type: "FLIGHT", icon: Plane, desc: "樂桃航空 MM620 紅眼航班，台北 T1 至成田 T1。", tag: "TPE -> NRT", color: "border-sky-500 text-sky-600" },
      { time: "06:30", title: "抵達成田機場 T1", type: "ARRIVAL", icon: MapPin, desc: "入境手續、領取行李、購買 Suica/Pass。", color: "border-green-500 text-green-600" },
      { time: "07:30", title: "搭乘京成電鐵", type: "TRANSPORT", icon: Train, desc: "前往上野，尋找置物櫃或前往飯店。", color: "border-blue-400 text-blue-600" },
      { time: "09:00", title: "上野公園散步", type: "SIGHTSEEING", icon: Camera, desc: "早晨的公園漫步，呼吸新鮮空氣。", color: "border-teal-400 text-teal-600" },
      { time: "11:00", title: "Check-in / 寄放行李", type: "HOTEL", icon: Home, desc: "前往上野住宿處寄放行李。", color: "border-purple-400 text-purple-600" },
      { time: "12:30", title: "午餐：一蘭拉麵", type: "FOOD", icon: Utensils, desc: "補充體力，快速解決午餐。", color: "border-orange-400 text-orange-600" },
      { time: "15:00", 
        title: "銀座逛街", 
        type: "SHOPPING", 
        icon: ShoppingBag, 
        desc: "在銀座感受東京的奢華氛圍。點擊此卡片查看詳細備註。", 
        color: "border-pink-400 text-pink-600",
        // 新增圖片和備註
        imageUrl: "https://placehold.co/400x200/fecaca/ffffff?text=銀座+Ginza",
        notes: "重點逛 Ginza Six 和三越百貨，記得去看 Hermes 旗艦店建築。可以去文具店 Itoya 看看日本設計。"
      },
      { time: "19:30", title: "晚餐：池袋美食街", type: "FOOD", icon: Utensils, desc: "享受豐盛的日式晚餐。", color: "border-orange-400 text-orange-600" },
    ]
  },
  {
    dayId: "day2",
    dateNum: "12",
    dayName: "SUN",
    fullDate: "1/12",
    title: "鎌倉湘南",
    events: [
      { time: "08:00", title: "築地市場", type: "FOOD", icon: Utensils, desc: "享用新鮮海鮮丼早餐。", color: "border-orange-400 text-orange-600" },
      { time: "10:30", 
        title: "鎌倉大佛", 
        type: "SIGHTSEEING", 
        icon: Camera, 
        desc: "高得院參拜，感受古都氛圍。點擊此卡片查看詳細備註。", 
        color: "border-teal-400 text-teal-600",
        // 新增圖片和備註
        imageUrl: "https://placehold.co/400x200/99f6e4/083344?text=鎌倉大佛+Kotoku-in",
        notes: "推薦參拜後沿著小徑散步。必吃附近的大佛布丁，口味特別。進入寺廟時請保持肅靜。"
      },
      { time: "12:00", title: "鶴岡八幡宮", type: "SIGHTSEEING", icon: MapPin, desc: "熱鬧的小町通商店街午餐。", color: "border-red-400 text-red-600" },
      { time: "15:00", title: "鎌倉高校前", type: "SIGHTSEEING", icon: Camera, desc: "灌籃高手平交道，拍網美照。", color: "border-blue-400 text-blue-600" },
      { time: "20:00", title: "SHIBUYA SKY", type: "SIGHTSEEING", icon: Camera, desc: "俯瞰東京夜景 (需提前預約)。", tag: "預約濟", color: "border-orange-400 text-orange-600" } 
    ]
  },
  {
    dayId: "day3",
    dateNum: "13",
    dayName: "MON",
    fullDate: "1/13",
    title: "富士購物",
    events: [
      { time: "09:00", title: "前往御殿場", type: "TRANSPORT", icon: BusIcon, desc: "搭乘巴士前往 Outlet。", color: "border-blue-400 text-blue-600" },
      { time: "11:00", title: "御殿場 Outlet", type: "SHOPPING", icon: ShoppingBag, desc: "眺望富士山，瘋狂購物時間。點擊此卡片查看詳細備註。", color: "border-pink-400 text-pink-600" },
      { time: "18:00", title: "阿美橫丁", type: "FOOD", icon: Utensils, desc: "返回上野，居酒屋晚餐與藥妝補貨。", color: "border-orange-400 text-orange-600" }
    ]
  },
  {
    dayId: "day4",
    dateNum: "14",
    dayName: "TUE",
    fullDate: "1/14",
    title: "下町藝術",
    events: [
      { time: "09:00", 
        title: "淺草寺", 
        type: "SIGHTSEEING", 
        icon: MapPin, 
        desc: "雷門拍照、仲見世通吃人形燒。點擊此卡片查看詳細備註。", 
        color: "border-red-500 text-red-600",
        // 新增圖片和備註
        imageUrl: "https://placehold.co/400x200/f87171/ffffff?text=淺草寺+Sensoji",
        notes: "參拜路線：雷門 -> 仲見世通 -> 寶藏門 -> 本堂。記得在仲見世通買人形燒和伴手禮。"
      },
      { time: "12:00", title: "敘敘苑燒肉", type: "FOOD", "icon": Utensils, desc: "晴空塔店，午間套餐。", tag: "需預約", color: "border-orange-400 text-orange-600" },
      { time: "15:00", title: "飯店移動", type: "HOTEL", icon: Home, desc: "移動至東京灣東方飯店 Check-in。", color: "border-purple-400 text-purple-600" },
      { time: "17:00", title: "teamLab Planets", type: "ART", icon: Camera, desc: "豐洲數位藝術展 (記得穿短褲)。", color: "border-indigo-400 text-indigo-600" }
    ]
  },
  {
    dayId: "day5",
    dateNum: "15",
    dayName: "WED",
    fullDate: "1/15",
    title: "迪士尼",
    events: [
      { time: "08:00", 
        title: "迪士尼海洋", 
        type: "FUN", 
        icon: MapPin, 
        desc: "夢幻泉鄉、Duffy、遊行。點擊此卡片查看詳細備註。", 
        tag: "DPA/PP", 
        color: "border-sky-400 text-sky-600",
        // 新增圖片和備註
        imageUrl: "https://placehold.co/400x200/bae6fd/0c4a6e?text=迪士尼海洋+Sea",
        notes: "必玩：驚魂古塔、地心探險。必吃：Duffy 甜點和火雞腿。先抽 DPA/PP！"
      },
      { time: "20:30", title: "夜間煙火", type: "SHOW", icon: Camera, desc: "Believe! Sea of Dreams.", color: "border-purple-500 text-purple-600" }
    ]
  },
  {
    dayId: "day6",
    dateNum: "16",
    dayName: "THU",
    fullDate: "1/16",
    title: "返程",
    events: [
      { time: "10:00", title: "Aeon Mall", type: "SHOPPING", icon: ShoppingBag, desc: "幕張新都心，最後衝刺。", color: "border-pink-400 text-pink-600" },
      { time: "14:00", title: "前往成田機場 T2", type: "TRANSPORT", icon: Plane, desc: "搭乘交通工具前往成田 T2，準備辦理登機。", color: "border-blue-400 text-blue-600" },
      { time: "18:25", title: "IT203 返台", type: "FLIGHT", icon: Plane, desc: "台灣虎航 IT203，成田 T2 (18:25) 至台北 T1 (21:30)。", color: "border-sky-500 text-sky-600" }
    ]
  }
];

function BusIcon(props) {
  return (
    <svg 
      {...props}
      xmlns="http://www.w3.org/2000/svg" 
      width="24" 
      height="24" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      strokeWidth="2" 
      strokeLinecap="round" 
      strokeLinejoin="round"
    >
      <path d="M8 6v6" />
      <path d="M15 6v6" />
      <path d="M2 12h19.6" />
      <path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3" />
      <circle cx="7" cy="18" r="2" />
      <path d="M9 18h5" />
      <circle cx="16" cy="18" r="2" />
    </svg>
  );
}

// --- Components ---

// 1. Weather Widget (即時天氣)
const WeatherWidget = () => (
  // 輕微調整漸層，讓卡片更精緻
  <div className="bg-gradient-to-br from-blue-50 to-sky-100 p-6 rounded-[2rem] border border-blue-200 shadow-xl relative mb-6">
    
    <h3 className="text-gray-700 font-bold text-xl mb-4 flex items-center gap-2 font-sans">
      即時天氣
    </h3>
    
    {/* Large Display Area: Icon, Temp, Condition */}
    <div className="flex items-center justify-between mb-6">
        
        {/* Left: Temperature and Condition */}
        <div className="flex flex-col">
            {/* 溫度字體: text-6xl -> text-5xl (已修改) */}
            <span className="text-5xl font-semibold text-gray-800 font-serif leading-none">8°C</span>
            {/* 晴朗位置調整到下方，更突出: text-2xl -> text-xl (已修改) */}
            <span className="text-xl text-gray-600 mt-2 font-sans font-medium">晴朗</span>
        </div>
        
        {/* Right: Large Icon for visual appeal */}
        <Sun size={56} className="text-yellow-500 flex-shrink-0 drop-shadow-lg" strokeWidth={1.5}/>
    </div>
    
    {/* Details Section: Clean Grid for high/low and rain */}
    <div className="grid grid-cols-2 gap-4 pt-4 border-t border-blue-300/30">
        
       {/* 1. 最高/最低溫 */}
       <div className="flex items-center gap-3 p-2 bg-white/50 rounded-lg">
          <Thermometer size={20} className="text-red-500 flex-shrink-0"/> 
          <div className="flex flex-col">
             <span className="text-xs text-gray-400 font-bold uppercase font-sans">高 / 低溫</span>
             {/* text-base -> text-lg */}
             <span className="text-lg text-gray-700 font-serif font-bold">12° / 5°</span>
          </div>
       </div>
       
       {/* 2. 降雨機率 */}
       <div className="flex items-center gap-3 p-2 bg-white/50 rounded-lg">
          <Droplets size={20} className="text-blue-500 flex-shrink-0"/>
          <div className="flex flex-col">
             <span className="text-xs text-gray-400 font-bold uppercase font-sans">降雨機率</span>
             {/* text-base -> text-lg */}
             <span className="text-lg text-gray-700 font-serif font-bold">30%</span>
          </div>
       </div>
    </div>
  </div>
);

// 2. Flight Summary (航班資訊)
const FlightSummary = () => {
  // FlightCard 結構調整，分離航班號碼和名稱，以便獨立控制字體大小
  const FlightCard = ({ departure, arrival, flightName, flightNum, date, time, terminal, direction }) => (
    <div className={`p-4 rounded-xl border-l-4 ${direction === 'outbound' ? 'border-sky-500 bg-sky-50/50' : 'border-indigo-500 bg-indigo-50/50'} mb-3 last:mb-0`}>
      <div className="flex justify-between items-start">
        <div className="flex flex-col">
          {/* text-[10px] -> text-xs */}
          <span className="text-xs font-bold text-gray-500 uppercase font-sans">{direction === 'outbound' ? '去程' : '回程'} - {date}</span>
          {/* 航班號碼: text-base -> text-lg, 航空公司名稱: text-sm -> text-base */}
          <h4 className="text-lg font-serif font-semibold text-gray-800">{flightNum} <span className="text-base font-normal text-gray-500 font-sans">({flightName})</span></h4> 
        </div>
        <Plane size={18} className={direction === 'outbound' ? 'text-sky-500 rotate-90' : 'text-indigo-500 -rotate-90'} />
      </div>
      
      <div className="mt-3 grid grid-cols-2 gap-4 text-sm pt-2 border-t border-gray-100">
        <div className="flex flex-col">
          {/* text-xs -> text-sm */}
          <span className="text-sm text-gray-400 font-sans">出發 ({departure} T{terminal[0]})</span>
          {/* text-base -> text-lg */}
          <span className="font-serif font-bold text-gray-700 text-lg">{time[0]}</span>
        </div>
        <div className="flex flex-col">
          {/* text-xs -> text-sm */}
          <span className="text-sm text-gray-400 font-sans">抵達 ({arrival} T{terminal[1]})</span>
          {/* text-base -> text-lg */}
          <span className="font-serif font-bold text-gray-700 text-lg">{time[1]}</span>
        </div>
      </div>
    </div>
  );

  return (
    <div className="bg-white p-5 rounded-[2rem] border border-gray-200 mb-6 shadow-[0_8px_16px_-6px_rgba(0,0,0,0.05)] relative group">
      {/* text-lg -> text-xl */}
      <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2 font-serif">
        航班資訊
      </h3>
      
      {/* 往程 */}
      <FlightCard 
        direction="outbound"
        date="1/11"
        flightNum="MM620"
        flightName="樂桃航空"
        departure="TPE"
        arrival="NRT"
        terminal={[1, 1]}
        time={["02:25", "06:30"]}
      />
      
      {/* 回程 */}
      <FlightCard 
        direction="return"
        date="1/16"
        flightNum="IT203"
        flightName="台灣虎航"
        departure="NRT"
        arrival="TPE"
        terminal={[2, 1]}
        time={["18:25", "21:30"]}
      />
    </div>
  );
};

// 3. Accommodation Summary (住宿資訊)
const AccommodationSummary = () => {
    // 住宿卡片元件
    const AccommodationCard = ({ name, duration, period, link, direction }) => (
        <div className={`p-4 rounded-xl border-l-4 ${direction === 'first' ? 'border-amber-500 bg-amber-50/50' : 'border-purple-500 bg-purple-50/50'} mb-3 last:mb-0`}>
            <div className="flex justify-between items-start">
                <div className="flex flex-col">
                    {/* text-[10px] -> text-xs */}
                    <span className="text-xs font-bold text-gray-500 uppercase font-sans">{period}</span>
                    {/* text-base -> text-lg */}
                    <h4 className="text-lg font-serif font-semibold text-gray-800">{name}</h4>
                </div>
                {/* 使用 Home icon 代表住宿 */}
                <Home size={18} className={direction === 'first' ? 'text-amber-500' : 'text-purple-500'} />
            </div>

            <div className="mt-3 flex justify-between items-center pt-2 border-t border-gray-100">
                {/* text-sm -> text-base */}
                <span className="text-base text-gray-400 font-sans">{duration}</span>
                {/* 導航按鈕: text-xs -> text-sm */}
                <a 
                    href={link} 
                    target="_blank" 
                    rel="noopener noreferrer" 
                    className="flex items-center gap-1 text-sm font-bold text-blue-600 hover:text-blue-800 transition-colors bg-blue-100 px-3 py-1 rounded-full"
                >
                    <MapPin size={14} /> {/* Icon size adjusted */}
                    導航
                </a>
            </div>
        </div>
    );

    return (
        <div className="bg-white p-5 rounded-[2rem] border border-gray-200 mb-6 shadow-[0_8px_16px_-6px_rgba(0,0,0,0.05)] relative group">
            {/* text-lg -> text-xl */}
            <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2 font-serif">
                住宿資訊
            </h3>
            
            {/* Paul House (前 3 晚) */}
            <AccommodationCard 
                direction="first"
                name="Paul house"
                period="1/11 - 1/13 (3晚)"
                duration="前 3 晚"
                // 連結已更新為使用者提供的正確網址
                link="https://maps.app.goo.gl/B6MVRPFDXG3FyPuCA"
            />
            
            {/* 東京灣東方飯店 (後 2 晚) */}
            <AccommodationCard 
                direction="second"
                name="東京灣東方飯店"
                period="1/14 - 1/15 (2晚)"
                duration="後 2 晚"
                link="https://maps.app.goo.gl/MyL4zjzFMQf3rbWX7"
            />
        </div>
    );
};

// 4. Checklist (行前清單)
const Checklist = () => {
  const [items, setItems] = useState([
    { id: 1, text: "護照 (效期6個月以上)", done: false },
    { id: 2, text: "Visit Japan Web 填寫", done: true },
    { id: 3, text: "日幣現金 / 信用卡", done: false },
    { id: 4, text: "西瓜卡 / 交通卡", done: false },
    { id: 5, text: "行動網卡 /漫遊", done: false },
  ]);

  const toggleItem = (id) => {
    setItems(items.map(item => item.id === id ? { ...item, done: !item.done } : item));
  };

  return (
    <div className="bg-[#fffcf7] p-6 rounded-[2rem] border border-[#f0e6d2] mb-6 relative overflow-hidden">
      {/* Tape effect */}
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-4 bg-[#e8e0d0]/50 rotate-[-1deg]"></div>
      
      {/* text-lg -> text-xl */}
      <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2 font-serif">
        Checklist
      </h3>
      <div className="space-y-3">
        {items.map(item => (
          <div 
            key={item.id} 
            onClick={() => toggleItem(item.id)}
            className="flex items-center gap-3 cursor-pointer group"
          >
            <div className={`w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center transition-all ${item.done ? 'bg-gray-700 border-gray-700' : 'bg-white'}`}>
              {item.done && <CheckSquare size={12} className="text-white" />}
            </div>
            {/* text-sm -> text-base */}
            <span className={`text-base font-medium transition-all ${item.done ? 'text-gray-300 line-through' : 'text-gray-600'} font-sans`}>{item.text}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- Itinerary Components ---

const DateSelector = ({ selectedDayId, onSelect }) => {
  const scrollRef = useRef(null);

  // 日期選擇器自動捲動邏輯 (保持日期選擇器的橫向滾動)
  useEffect(() => {
    if (scrollRef.current && selectedDayId) {
      const selectedElement = scrollRef.current.querySelector(`[data-day-id="${selectedDayId}"]`);
      if (selectedElement) {
        selectedElement.scrollIntoView({
          behavior: 'smooth',
          inline: 'center' 
        });
      }
    }
  }, [selectedDayId]);

  return (
    <div className="sticky top-0 z-20 bg-[#f5f2eb]/95 backdrop-blur-sm border-b border-gray-200/50 pb-2 pt-2">
      <div 
        ref={scrollRef}
        className="flex overflow-x-auto gap-4 px-6 scrollbar-hide snap-x"
        style={{ scrollBehavior: 'smooth' }}
      >
        {itineraryData.map((day, index) => {
          const isSelected = selectedDayId === day.dayId;
          
          // 星期幾改成 DAY 幾 (PREP for Day 0)
          const dayNumber = index;
          const displayDayName = dayNumber === 0 ? 'PREP' : `DAY ${dayNumber}`;
          
          return (
            <button
              key={day.dayId}
              data-day-id={day.dayId} // for auto-scroll
              onClick={() => onSelect(day.dayId)}
              className={`flex flex-col items-center justify-center min-w-[3.5rem] py-2 rounded-2xl transition-all duration-300 snap-center
                ${isSelected 
                  ? 'bg-gray-800 text-[#f5f2eb] scale-105 shadow-md' 
                  : 'text-gray-400 hover:text-gray-600'
                }`}
            >
              {/* text-[10px] -> text-xs */}
              <span className="text-xs font-bold tracking-widest uppercase mb-0.5 font-sans">{displayDayName}</span>
              {/* text-xl -> text-2xl */}
              <span className={`text-2xl font-serif ${isSelected ? 'font-light' : 'font-normal'}`}>{day.dateNum}</span>
            </button>
          );
        })}
      </div>
    </div>
  );
};

// 5. EventModal 元件 (備註標題和圖示已更新為 AlertCircle)
const EventModal = ({ event, onClose }) => {
    if (!event) return null;

    // 提取事件數據
    const { title, time, desc, imageUrl, notes, icon: IconComponent, type, color } = event;
    
    // 根據事件顏色生成 Tailwind CSS class
    // e.g., 'border-teal-400 text-teal-600' -> 'text-teal-600'
    const baseColorClass = color.split(' ').find(cls => cls.startsWith('text-'));
    // e.g., 'border-teal-400 text-teal-600' -> 'bg-teal-400' (用於背景)
    const bgColorClass = color.split(' ').find(cls => cls.startsWith('border-')).replace('border-', 'bg-');
    const borderColorClass = color.split(' ').find(cls => cls.startsWith('border-'));

    return (
        // Modal Overlay (使用 fixed 覆蓋全螢幕)
        <div 
            className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] p-4 backdrop-blur-sm transition-opacity duration-300 animate-fadeIn" 
            onClick={onClose}
        >
            
            {/* Modal Content */}
            <div 
                className="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg mx-auto max-h-[90vh] flex flex-col transform transition-all duration-300 scale-100" 
                onClick={e => e.stopPropagation()} // 防止點擊內容時關閉 Modal
                style={{ fontFamily: 'Noto Sans TC, sans-serif' }}
            >
                
                {/* Header with Title and Close Button */}
                <div className="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white rounded-t-[2rem]">
                    <h2 className={`text-2xl font-bold font-serif ${baseColorClass}`}>{title}</h2>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 focus:outline-none p-1 transition-colors">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                {/* Scrollable Content Area */}
                <div className="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    
                    {/* Image (if exists) */}
                    {imageUrl && (
                        <div className="mb-6 rounded-2xl overflow-hidden shadow-lg border border-gray-100">
                            <img 
                                src={imageUrl} 
                                alt={title} 
                                className="w-full h-auto object-cover" 
                                onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x200/cccccc/333333?text=圖片載入失敗+請檢查URL"; }}
                            />
                        </div>
                    )}
                    
                    {/* Time & Type Tag */}
                    <div className="flex items-center gap-3 mb-4 text-sm text-gray-500">
                         <Calendar size={16} className="text-indigo-400" />
                         <span className="font-semibold text-gray-700 font-serif">{time}</span>
                         <span className={`text-xs font-bold tracking-widest uppercase px-2 py-1 rounded-full ${bgColorClass.replace('bg-', 'bg-')}/30 ${baseColorClass}`}>{type}</span>
                    </div>

                    {/* Description (景點介紹) */}
                    <div className={`mb-6 p-4 rounded-xl shadow-inner border ${borderColorClass.replace('border-', 'border-')}/30 ${bgColorClass.replace('bg-', 'bg-')}/20`}>
                        <h3 className={`text-lg font-semibold mb-2 flex items-center ${baseColorClass}`}>
                            <IconComponent size={20} className="mr-2"/>
                            景點介紹
                        </h3>
                        {/* 修正描述，移除結尾的贅詞 */}
                        <p className="text-gray-700 leading-relaxed text-base">{desc.replace('。點擊此卡片查看詳細備註。', '。')}</p>
                    </div>

                    {/* Notes (備註) - 標題和圖示已更新為 AlertCircle */}
                    {notes && (
                        <div className="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow-md">
                            <h3 className="text-lg font-semibold text-yellow-800 mb-2 flex items-center">
                                <AlertCircle size={20} className="mr-2"/> {/* 使用帶圓圈的感嘆號圖示 */}
                                備註
                            </h3>
                            <p className="text-gray-700 leading-relaxed text-base">{notes}</p>
                        </div>
                    )}
                </div>

                {/* Footer Button */}
                <div className="p-4 bg-gray-50 border-t border-gray-100 rounded-b-[2rem]">
                    <button 
                        onClick={onClose} 
                        className={`w-full ${bgColorClass.replace('bg-', 'bg-')}/70 ${baseColorClass} font-bold py-3 rounded-xl hover:opacity-80 transition duration-150 shadow-md`}
                    >
                        關閉詳情
                    </button>
                </div>
            </div>

            {/* Modal specific style for scrollbar */}
            <style jsx="true">{`
              .custom-scrollbar::-webkit-scrollbar {
                  width: 8px;
              }
              .custom-scrollbar::-webkit-scrollbar-track {
                  background: #f7f7f9;
              }
              .custom-scrollbar::-webkit-scrollbar-thumb {
                  background-color: #cbd5e1; /* slate-300 */
                  border-radius: 20px;
                  border: 2px solid #f7f7f9;
              }
              @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
              }
              .animate-fadeIn {
                animation: fadeIn 0.3s ease-out forwards;
              }
            `}</style>
        </div>
    );
};


const TimelineItem = ({ event, isLast, onEventClick }) => {
  return (
    <div className="flex relative group">
      {/* Left Column: Time */}
      <div className="w-16 flex-shrink-0 text-right pr-4 pt-1">
        {/* text-lg -> text-xl */}
        <span className="font-serif text-xl text-gray-800 tracking-wide block">{event.time}</span>
        {/* Decorative circle on the timeline */}
        <div className={`absolute left-[4.5rem] top-3 w-2 h-2 rounded-full border-2 border-[#f5f2eb] outline outline-1 outline-gray-300 bg-white z-10 
          group-hover:bg-gray-800 transition-colors duration-300`}></div>
      </div>

      {/* Right Column: Content */}
      <div className={`flex-1 pb-10 pl-6 border-l border-gray-200 relative ${isLast ? 'border-transparent' : ''}`}>
        
        {/* Card - Now clickable to open Modal */}
        <div 
           className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100/50 hover:shadow-lg transition-shadow duration-300 cursor-pointer overflow-hidden"
           onClick={() => onEventClick(event)}
        >
           
           {/* 新增: 圖片顯示區塊 (如果 imageUrl 存在) */}
           {event.imageUrl && (
                <div className="mb-3 -mt-4 -mx-4 overflow-hidden shadow-inner border-b border-gray-100">
                    <img 
                        src={event.imageUrl} 
                        alt={event.title} 
                        className="w-full h-32 object-cover" // 固定高度 h-32
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x128/cccccc/333333?text=圖片載入失敗"; e.target.classList.add('p-4', 'h-auto', 'text-center'); }}
                    />
                </div>
            )}


           <div className="flex justify-between items-start mb-2 pt-1">
             {/* 調整行程事件標題字體大小: text-2xl -> text-xl */}
             <h3 className="font-serif text-xl text-gray-800 leading-tight">{event.title}</h3>
             {event.tag && (
               <span className="text-xs font-bold text-red-400 border border-red-200 bg-red-50 px-2 py-0.5 rounded-full transform rotate-[-2deg] font-sans">
                 {event.tag}
               </span>
             )}
           </div>

           <div className="flex items-center gap-2 mb-3">
              <event.icon size={14} className="text-gray-400 uppercase" /> {/* Icon size adjusted */}
              {/* text-[10px] -> text-xs */}
              <span className="text-xs text-gray-400 font-bold tracking-widest uppercase font-sans">{event.type}</span>
           </div>
           
           {/* 這裡只顯示摘要描述，詳細的圖片和備註移到 Modal 中 */}
           <p className="text-base text-gray-500 font-light leading-relaxed border-l-2 pl-3 border-gray-100 font-sans">
             {/* 修正描述，移除結尾的贅詞 */}
             {event.desc.replace('。點擊此卡片查看詳細推薦備註。', '。點擊此卡片查看詳細備註。')} 
           </p>

           {/* Colored accent bar on the left of the card content */}
           <div className={`absolute left-6 top-4 bottom-4 w-1 rounded-full ${event.color.split(' ')[0].replace('border-', 'bg-')}`}></div>
        </div>

      </div>
    </div>
  );
};

// --- Main App ---

export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  // 更改預設選取的行程日為 Day 0 (1/10)
  const [selectedDayId, setSelectedDayId] = useState('day0'); // Default to Day 0
  
  // NEW STATE: 用於控制模態框，儲存當前被點擊的事件
  const [selectedEvent, setSelectedEvent] = useState(null);

  const timelineRef = useRef(null); 

  // Modal handlers
  const openModal = (event) => setSelectedEvent(event);
  const closeModal = () => setSelectedEvent(null);

  // Effect to smoothly scroll the timeline content to the top when the selected day changes.
  // This addresses the "不要一直跳動" requirement by resetting the scroll position.
  useEffect(() => {
    if (activeTab === 'itinerary' && timelineRef.current) {
      timelineRef.current.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
  }, [selectedDayId, activeTab]);


  // Get current selected day data
  const currentDayData = itineraryData.find(d => d.dayId === selectedDayId);

  return (
    <div className="min-h-screen bg-[#f5f2eb] font-sans text-gray-800 pb-24 max-w-md mx-auto shadow-2xl overflow-hidden relative">
      
      {/* Global Background Texture */}
      <div className="fixed inset-0 pointer-events-none opacity-60 mix-blend-multiply" 
           style={{ backgroundImage: `url("https://www.transparenttextures.com/patterns/cream-paper.png")` }}></div>

      {/* Header - Changes based on tab */}
      <header className="bg-[#f5f2eb]/90 backdrop-blur-md sticky top-0 z-50 px-6 pt-12 pb-4 flex justify-between items-end">
         {activeTab === 'home' ? (
           <div className="animate-fadeIn">
              <p className="text-xs text-gray-400 font-bold tracking-[0.2em] mb-1 font-sans">FAMILY TRIP</p>
              {/* 年份：2026: text-3xl -> text-4xl, text-lg -> text-xl */}
              <h1 className="text-4xl font-serif text-gray-800">東京旅行 <span className="text-xl bg-gray-800 text-white rounded-full px-3 py-1 ml-1 align-middle font-sans">2026</span></h1>
           </div>
         ) : (
           <div className="w-full">
              <p className="text-center text-xs text-gray-400 font-bold tracking-[0.2em] mb-1 font-sans">TRIP SCHEDULE</p>
              {/* 調整行程標題字體大小: text-3xl -> text-2xl */}
              <h1 className="text-center text-2xl font-serif text-gray-800">{currentDayData?.title}</h1>
           </div>
         )}
         
         {activeTab === 'home' && (
           <div className="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm">
             <span className="font-serif italic font-bold text-lg text-gray-800">7</span>
           </div>
         )}
      </header>

      {/* Main Content */}
      <main className="relative z-10 h-full">
        
        {/* Tab: Home */}
        {activeTab === 'home' && (
          <div className="px-6 py-4 animate-fadeIn">
            <WeatherWidget /> {/* 即時天氣 */}
            <FlightSummary /> {/* 航班資訊 */}
            <AccommodationSummary /> {/* 新增住宿資訊 */}
            <Checklist /> {/* 行前清單 */}
            
            {/* Memo Note */}
            <div className="mt-8 p-6 bg-yellow-50/50 rounded-xl border-l-4 border-yellow-200">
              <h4 className="font-bold text-lg text-gray-600 mb-2 font-serif italic">Memo</h4>
              {/* text-sm -> text-base */}
              <p className="text-base text-gray-500 leading-relaxed font-sans">
                記得帶轉接頭，日本電壓是100V。走路會走很多，一定要穿好走的鞋子！
              </p>
            </div>
          </div>
        )}

        {/* Tab: Itinerary */}
        {activeTab === 'itinerary' && (
          // 滾動容器的 Ref
          <div 
            ref={timelineRef} 
            className="h-[calc(100vh-180px)] overflow-y-auto scrollbar-hide"
          >
            <DateSelector selectedDayId={selectedDayId} onSelect={setSelectedDayId} />
            
            <div className="px-5 py-6">
              {currentDayData && currentDayData.events.map((event, index) => (
                <TimelineItem 
                  key={index} 
                  event={event} 
                  isLast={index === currentDayData.events.length - 1} 
                  onEventClick={openModal} // 傳遞開啟 Modal 的函式
                />
              ))}
              
              {/* End of Day Marker */}
              <div className="flex justify-center mt-8 opacity-50">
                 <div className="w-2 h-2 bg-gray-300 rounded-full mx-1"></div>
                 <div className="w-2 h-2 bg-gray-300 rounded-full mx-1"></div>
                 <div className="w-2 h-2 bg-gray-300 rounded-full mx-1"></div>
              </div>
            </div>
          </div>
        )}

      </main>

      {/* MODAL COMPONENT - Only renders when an event is selected */}
      <EventModal event={selectedEvent} onClose={closeModal} />

      {/* Bottom Navigation */}
      <nav className="fixed bottom-8 left-8 right-8 bg-gray-900 text-white shadow-2xl rounded-full px-2 py-2 z-50 flex justify-between items-center max-w-[350px] mx-auto">
        
        <button 
          onClick={() => setActiveTab('home')}
          className={`flex-1 flex items-center justify-center py-3 rounded-full transition-all duration-300 ${activeTab === 'home' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}
        >
          <Home size={22} strokeWidth={2} className={activeTab === 'home' ? 'text-white' : 'text-gray-400'} />
          {activeTab === 'home' && <span className="ml-2 text-sm font-bold tracking-wider font-sans">HOME</span>}
        </button>

        <button 
          onClick={() => setActiveTab('itinerary')}
          className={`flex-1 flex items-center justify-center py-3 rounded-full transition-all duration-300 ${activeTab === 'itinerary' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}
        >
          <Calendar size={22} strokeWidth={2} className={activeTab === 'itinerary' ? 'text-white' : 'text-gray-400'} />
          {activeTab === 'itinerary' && <span className="ml-2 text-sm font-bold tracking-wider font-sans">PLAN</span>}
        </button>

      </nav>
      
      {/* Styles (字體設定) */}
      <style>{`
        /* 使用 Noto Sans TC 作為主要中文字體，Inter 專門用於數字和強調文字 (font-serif) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
          font-family: 'Noto Sans TC', sans-serif; /* 主要中文字體 */
        }
        .font-sans {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .font-serif {
          /* 使用 Inter 來處理數字和強調的標題，它有很好的數字設計 */
          font-family: 'Inter', sans-serif; 
        }
        
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.4s ease-out forwards;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
      `}</style>
    </div>
  );
}
