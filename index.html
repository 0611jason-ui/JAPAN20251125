<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的日系旅程儀表板</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght+400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #fcfbf9; /* 更溫暖的紙張白 */
            color: #4b5563;
            -webkit-tap-highlight-color: transparent; /* 移除點擊高亮 */
            padding-bottom: 6rem; /* 為底部導航欄留出空間 */
            overflow-x: hidden; /* 確保沒有水平滾動 */
        }

        /* 隱藏滾動條但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 類似手帳本的卡片陰影 (日系簡約風) */
        .app-card {
            background: white;
            border-radius: 1.25rem; /* 稍微大一點的圓角 */
            box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.04); /* 輕柔陰影 */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        /* 點擊時輕微縮小，更有回應感 (應用於可點擊元素) */
        .app-card.interactive:active {
            transform: scale(0.99);
            box-shadow: 0 2px 8px -1px rgba(0, 0, 0, 0.03);
        }

        /* Timeline 連接線 */
        .timeline-line {
            width: 2px;
            background: #e5e7eb;
            position: absolute;
            top: 0;
            bottom: -1rem;
            left: 1.25rem;
            z-index: 0;
        }
        .timeline-container {
            padding-top: 1.5rem;
        }

        /* 頁面切換控制：確保一次只顯示一個頁面 */
        .page-transition {
            transition: opacity 0.3s ease;
        }
        .hidden-page {
            display: none; /* 關鍵：確保內容不堆疊 */
            opacity: 0;
            pointer-events: none;
        }
        .active-page {
            display: block; /* 關鍵：顯示頁面 */
            opacity: 1;
            pointer-events: auto;
        }
        
        /* 頁面淡入動畫 */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.4s ease-out forwards;
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            opacity: 0;
            animation: slide-up 0.4s ease-out forwards;
        }

        /* Modal 啟用時的動畫 */
        .modal-active #detail-modal {
            pointer-events: auto;
            opacity: 1;
        }
        .modal-active #modal-content {
            transform: translateY(0);
        }
        #modal-content {
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        /* 針對桌機/平板尺寸的 Modal 調整 */
        @media (min-width: 640px) {
            #modal-content {
                transform: scale(0.95);
                opacity: 0;
            }
            .modal-active #modal-content {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 頁面主容器 - 限制寬度讓手機版面更集中 -->
    <div class="max-w-xl mx-auto px-4 pt-8">
        
        <!-- ---------------------------------------------------- -->
        <!-- 1. 主頁面 (Home Page) 內容 - 旅遊儀表板 -->
        <!-- ---------------------------------------------------- -->
        <div id="home-page" class="page-transition hidden-page">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 tracking-wider">東京六日輕旅</h1>
                <p class="text-sm text-gray-400 mt-1">2024.01.11 - 01.16 | 歡迎回來！</p>
            </header>

            <!-- 1. 今日天氣卡片 (天氣資訊) -->
            <div class="app-card interactive p-6 mb-8 bg-gradient-to-br from-blue-400 to-indigo-500 text-white shadow-xl" onclick="alert('TODO: 顯示五日天氣預報')">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xl font-medium mb-1">東京，上野</p>
                        <h2 class="text-6xl font-extrabold">8°C</h2>
                        <p class="text-sm opacity-90 mt-1">多雲時晴，感覺涼爽</p>
                    </div>
                    <i data-lucide="cloud-sun" class="w-12 h-12 text-white/90"></i>
                </div>
                <div class="mt-4 pt-4 border-t border-white/30 text-xs flex justify-between">
                    <span>高溫: 11°C / 低溫: 4°C</span>
                    <span>降雨機率: 20%</span>
                </div>
            </div>

            <!-- 2. 航班資訊卡片 (航班資訊) -->
            <div class="app-card p-6 mb-8 bg-rose-50 border border-rose-100">
                <p class="text-xs font-bold text-rose-600 uppercase tracking-wider mb-2 flex items-center">
                    <i data-lucide="plane-takeoff" class="w-4 h-4 mr-1"></i>
                    航班資訊
                </p>
                
                <!-- 去程航班 (Day 1) -->
                <div class="border-b border-rose-100 pb-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i data-lucide="arrow-right" class="w-4 h-4 mr-2 text-rose-500"></i>
                            MM620 (樂桃)
                        </h3>
                        <span class="text-sm font-medium text-gray-500">去程 - 1/11</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-gray-700">
                        <span>02:25 (TPE T1)</span>
                        <span>06:30 (NRT T1)</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">紅眼航班，請提早休息。</p>
                </div>
                
                <!-- 回程航班 (Day 6) -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-2 text-rose-500"></i>
                            IT203 (虎航)
                        </h3>
                        <span class="text-sm font-medium text-gray-500">回程 - 1/16</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-gray-700">
                        <span>18:25 (NRT T2)</span>
                        <span>21:30 (TPE T1)</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">請預留充裕時間前往 T2 報到。</p>
                </div>
            </div>

            <!-- 3. 住宿資訊卡片 (住宿資訊) -->
            <div class="app-card p-6 mb-8 bg-cyan-50 border border-cyan-100">
                <p class="text-xs font-bold text-cyan-600 uppercase tracking-wider mb-4 flex items-center">
                    <i data-lucide="key-round" class="w-4 h-4 mr-1"></i>
                    住宿資訊 (共 5 晚)
                </p>
                
                <!-- 第一段住宿 (1/11 - 1/14) -->
                <div class="border-b border-cyan-100 pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center justify-between">
                        <span class="flex items-center">
                            Paul House
                            <!-- 導航按鈕 (保留不動，用於首頁住宿區塊) -->
                            <button onclick="window.open('https://maps.app.goo.gl/pT3x1xYM5SuEb5my6', '_blank')" class="ml-2 w-6 h-6 flex items-center justify-center text-xs font-bold text-white bg-cyan-500 hover:bg-cyan-600 rounded-full active:scale-[0.95] transition-transform shadow-md">
                                <i data-lucide="map-pin" class="w-3 h-3"></i>
                            </button>
                        </span>
                        <span class="text-sm font-medium text-cyan-700 bg-cyan-200/50 px-2 py-0.5 rounded-full">1/11 - 1/14 (3晚)</span>
                    </h3>
                </div>

                <!-- 第二段住宿 (1/14 - 1/16) -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center justify-between">
                        <span class="flex items-center">
                            東京灣東方飯店
                            <!-- 導航按鈕 (保留不動，用於首頁住宿區塊) -->
                            <button onclick="window.open('https://www.google.com/maps/search/' + encodeURIComponent('東京灣東方飯店'), '_blank')" 
        class="ml-2 w-6 h-6 flex items-center justify-center text-xs font-bold text-white bg-purple-500 hover:bg-purple-600 rounded-full active:scale-[0.95] transition-transform shadow-md">
</button>
                                <i data-lucide="map-pin" class="w-3 h-3"></i>
                            </button>
                        </span>
                        <span class="text-sm font-medium text-purple-700 bg-purple-200/50 px-2 py-0.5 rounded-full">1/14 - 1/16 (2晚)</span>
                    </h3>
                </div>
            </div>

            <!-- 4. 攜帶物品清單 (攜帶物品清單) -->
            <div class="app-card p-6 mb-8 bg-green-50 border border-green-100">
                <p id="packing-list-header" class="text-xs font-bold text-green-600 uppercase tracking-wider mb-4 flex items-center">
                    <i data-lucide="list-todo" class="w-4 h-4 mr-1"></i>
                    行前檢查清單 (載入中...)
                </p>
                <ul id="packing-list" class="space-y-3">
                    <!-- List items will be rendered by JS -->
                </ul>
            </div>
            
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- 2. 行程頁面 (Timeline Page) 內容 -->
        <!-- ---------------------------------------------------- -->
        <div id="timeline-page" class="page-transition hidden-page">
            
            <!-- 日期切換 Tab -->
            <div class="overflow-x-auto no-scrollbar flex space-x-3 mb-4 sticky top-0 bg-[#fcfbf9] py-3 z-20"> <!-- 縮小間距 -->
                <button onclick="renderTimeline(1)" id="tab-1" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-gray-800 text-white">
                    Day 1
                </button>
                <button onclick="renderTimeline(2)" id="tab-2" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-white text-gray-400 border border-gray-100">
                    Day 2
                </button>
                <button onclick="renderTimeline(3)" id="tab-3" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-white text-gray-400 border border-gray-100">
                    Day 3
                </button>
                <button onclick="renderTimeline(4)" id="tab-4" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-white text-gray-400 border border-gray-100">
                    Day 4
                </button>
                <button onclick="renderTimeline(5)" id="tab-5" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-white text-gray-400 border border-gray-100">
                    Day 5
                </button>
                <button onclick="renderTimeline(6)" id="tab-6" class="day-tab px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all shadow-sm bg-white text-gray-400 border border-gray-100">
                    Day 6
                </button>
            </div>

            <!-- 時間軸容器 -->
            <div id="timeline-container" class="relative pb-10 pl-2 timeline-container">
                <!-- 內容會由 JavaScript 動態生成 -->
            </div>

            <!-- 旅遊數據分析圖表區塊已移除 -->
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- 3. 地圖頁面 (Map Page) 內容 - 已移除 -->
        <!-- ---------------------------------------------------- -->
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- 4. 底部導航列 (Bottom Navigation Bar) -->
    <!-- ---------------------------------------------------- -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-xl mx-auto z-30 p-4 bg-white shadow-[0_-4px_15px_rgba(0,0,0,0.03)] rounded-t-2xl">
        <div class="flex justify-around">
            <!-- 導航列只剩下兩個按鈕：Home & Timeline -->
            <button id="nav-home" onclick="renderPage('home')" class="flex flex-col items-center p-2 text-gray-800 active-nav-item">
                <i data-lucide="house" class="w-5 h-5"></i>
                <span class="text-xs mt-1 font-medium">主頁</span>
            </button>
            <button id="nav-timeline" onclick="renderPage('timeline')" class="flex flex-col items-center p-2 text-gray-400 inactive-nav-item">
                <i data-lucide="list-checks" class="w-5 h-5"></i>
                <span class="text-xs mt-1 font-medium">行程</span>
            </button>
        </div>
    </nav>


    <!-- ---------------------------------------------------- -->
    <!-- 5. 全用型 Modal (Popup) -->
    <!-- ---------------------------------------------------- -->
    <!-- 在 body 標籤上切換 modal-active class 來控制 Modal 的顯示 -->
    <div id="detail-modal" class="fixed inset-0 z-50 pointer-events-none opacity-0 flex items-end sm:items-center sm:justify-center transition-opacity">
        <!-- 背景遮罩 -->
        <div onclick="closeModal()" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        
        <!-- Modal 本體 -->
        <div id="modal-content" class="w-full bg-white rounded-t-[2rem] sm:rounded-[2rem] sm:max-w-md sm:mx-auto p-6 pb-10 relative max-h-[85vh] overflow-y-auto no-scrollbar shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
            
            <!-- 拖曳條指示器 -->
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <!-- 內容動態填充區 -->
            <div id="modal-dynamic-body">
                <!-- JS 將會填充這裡 -->
            </div>

            <!-- 固定關閉按鈕 -->
            <button onclick="closeModal()" class="mt-8 w-full py-3.5 rounded-xl font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 active:scale-[0.99] transition-transform">
                關閉
            </button>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // Firebase Setup (Required for Canvas Environment)
        // ----------------------------------------------------
        const __app_id = 'travel-itinerary-app';
        const __firebase_config = '{}';
        const __initial_auth_token = '';
        
        // ----------------------------------------------------
        // 1. 行程資料庫 - 核心更新 (已新增鎌倉大佛圖片)
        // ----------------------------------------------------
        const itineraryData = {
            1: {
                date: "1/11 (週四)",
                theme: "成田抵達，上野寄放，涉谷潮流",
                items: [
                    { time: "06:30", title: "成田機場 (NRT T1) 入境", type: "transport", color: "blue", icon: "plane-landing", desc: "樂桃 MM620 抵達。辦理入境手續、購買交通券。", note: "紅眼航班，注意精神狀態。預計抵達 NRT T1。", hasImage: false },
                    { time: "08:00", title: "搭乘電車至京成上野站", type: "transport", color: "slate", icon: "train", desc: "搭乘京成電鐵或其他路線前往上野。", note: "在上野車站尋找大型置物櫃寄放行李。", hasImage: false },
                    { time: "10:00", title: "池袋地區漫步", type: "sightseeing", color: "yellow", icon: "map-pin", desc: "池袋東口或西口散步，熟悉周邊環境。", hasImage: false },
                    { time: "12:00", title: "午餐：池袋周邊", type: "food", color: "orange", icon: "utensils", desc: "在池袋尋找午餐，可能是拉麵或定食。", hasImage: false },
                    { time: "14:30", title: "澀谷、原宿、表參道", type: "shopping", color: "pink", icon: "shopping-bag", desc: "東京潮流文化集中地，逛街採購與感受氛圍。", note: "重點：竹下通、表參道精品店。", hasImage: true, image: "https://images.unsplash.com/photo-1547989470-87a8f107c134?auto=format&fit=crop&q=80&w=600" }, // 澀谷街景
                    { time: "17:30", title: "澀谷 SHIBUYA SKY 展望台", type: "sightseeing", color: "sky", icon: "telescope", desc: "登上展望台，欣賞東京日落及著名的十字路口。", note: "記得提前換票，預計在日落時段。", hasImage: true, image: "https://images.unsplash.com/photo-1536787680717-d2e825a0a4c0?auto=format&fit=crop&q=80&w=600" }, // SHIBUYA SKY
                    { time: "20:00", title: "Check-in Paul House (上野)", type: "stay", color: "indigo", icon: "bed", desc: "返回上野，領取行李，辦理 Paul House 入住。", note: "第一段住宿開始，共 3 晚。", hasImage: false }
                ]
            },
            2: {
                date: "1/12 (週五)",
                theme: "築地海鮮與鎌倉高校巡禮",
                items: [
                    { time: "08:00", title: "築地場外市場", type: "food", color: "orange", icon: "fish", desc: "早餐：海鮮丼、玉子燒等，享受新鮮美味。", note: "建議提早前往，避開人潮。", hasImage: true, image: "https://images.unsplash.com/photo-1518659684787-846399b14800?auto=format&fit=crop&q=80&w=600" },
                    { time: "10:30", title: "前往鎌倉 (江之島電鐵)", type: "transport", color: "slate", icon: "bus", desc: "搭乘電車前往鎌倉，準備開始一日遊。", note: "需購買一日券或使用交通卡。", hasImage: false },
                    { time: "12:00", title: "鶴岡八幡宮", type: "sightseeing", color: "red", icon: "church", desc: "鎌倉最主要的神社，感受古都的歷史氛圍。", hasImage: false },
                    { time: "14:00", title: "鎌倉大佛 (高德院)", type: "sightseeing", color: "green", icon: "mountain", desc: "日本第二大的佛像，近距離感受其莊嚴。", hasImage: true, image: "https://www.bring-you.info/imgs/2020/05/kamakura-daibutsu-11.jpg", mapLink: "https://maps.app.goo.gl/METUAAiYjGMZNZak8" },
                    { time: "16:00", title: "鎌倉高校前站", type: "sightseeing", color: "purple", icon: "camera", desc: "《灌籃高手》經典平交道場景拍照打卡。", note: "注意交通安全，不要影響當地居民。", hasImage: true, image: "https://images.unsplash.com/photo-1588667362615-56f4d2f8832c?auto=format&fit=crop&q=80&w=600" },
                    { time: "18:30", title: "晚餐 & 返回上野", type: "food", color: "orange", icon: "ramen", desc: "在鎌倉或返回上野後用晚餐。", hasImage: false }
                ]
            },
            3: {
                date: "1/13 (週六)",
                theme: "御殿場購物與阿美橫町",
                items: [
                    { time: "09:00", title: "御殿場 Premium Outlets", type: "shopping", color: "pink", icon: "gift", desc: "開始一整天的購物行程，靠近富士山。", note: "預留一整天時間，交通方式需提前確認 (巴士或火車)。", hasImage: true, image: "https://images.unsplash.com/photo-1574844622285-797305963b58?auto=format&fit=crop&q=80&w=600" }, // 購物圖
                    { time: "13:00", title: "午餐 (Outlet內)", type: "food", color: "orange", icon: "coffee", desc: "在 Outlet 內的美食廣場或餐廳用餐。", hasImage: false },
                    { time: "18:00", title: "阿美橫丁 (Ameya-Yokocho)", type: "shopping", color: "amber", icon: "store", desc: "返回上野，在阿美橫丁體驗熱鬧的市集氛圍，採購零食藥妝。", note: "Paul House 最後一晚。", hasImage: false },
                    { time: "20:00", title: "晚餐：阿美橫丁居酒屋", type: "food", color: "red", icon: "beer", desc: "在阿美橫丁附近享用日式居酒屋美食。", hasImage: false }
                ]
            },
            4: {
                 date: "1/14 (週日)",
                 theme: "淺草、晴空塔與 teamLab 移居舞濱",
                 items: [
                     { time: "09:00", title: "淺草寺與雷門", type: "sightseeing", color: "red", icon: "camera", desc: "參觀雷門、仲見世通，並參拜淺草寺。", hasImage: true, image: "https://images.unsplash.com/photo-1596395819057-d375226c7840?auto=format&fit=crop&q=80&w=600" },
                     { time: "11:00", title: "晴空塔 Skytree", type: "sightseeing", color: "sky", icon: "tower-control", desc: "參觀晴空塔及 Solamachi 商場。", hasImage: false },
                     { time: "13:00", title: "午餐：敘敘苑或同級燒肉", type: "food", color: "orange", icon: "flame", desc: "在晴空塔附近享用午餐燒肉。", hasImage: false },
                     { time: "15:00", title: "前往東京灣東方飯店 Check-in", type: "stay", color: "purple", icon: "luggage", desc: "從上野搭車前往舞濱，將行李寄放至飯店。", note: "第二段住宿開始 (2 晚)，預計 1/16 退房。", hasImage: false },
                     { time: "17:30", title: "teamLab Planets TOKYO DMM", type: "fun", color: "indigo", icon: "sparkles", desc: "體驗型數位藝術展，沉浸在光影世界。", note: "記得穿著輕便服裝，可能會赤腳及接觸水。", hasImage: true, image: "https://images.unsplash.com/photo-1550302450-4255146c303f?auto=format&fit=crop&q=80&w=600" } // teamLab 藝術展
                 ]
            },
            5: {
                date: "1/15 (週一)",
                theme: "迪士尼海洋樂園一日遊",
                items: [
                    { time: "08:30", title: "東京迪士尼海洋入園", type: "fun", color: "purple", icon: "sparkles", desc: "開始一整天的迪士尼海洋夢幻旅程。", note: "舞濱站搭乘單軌電車至海洋樂園。", hasImage: true, image: "https://images.unsplash.com/photo-1524312686702-861d8a573428?auto=format&fit=crop&q=80&w=600" },
                    { time: "12:00", title: "午餐 (園區內)", type: "food", color: "orange", icon: "cake", desc: "在園區內選擇主題餐廳或小吃。", hasImage: false },
                    { time: "18:00", title: "晚餐 (園區內)", type: "food", color: "red", icon: "ramen", desc: "在園區內用晚餐，準備欣賞夜間表演。", hasImage: false },
                    { time: "20:30", title: "夜間表演與煙火", type: "show", color: "indigo", icon: "music", desc: "觀看夜間水上表演或煙火秀。", note: "提前找好觀賞位置。", hasImage: true, image: "https://images.unsplash.com/photo-1518281361980-b26bfd556770?auto=format&fit=crop&q=80&w=600" }
                ]
            },
            6: {
                 date: "1/16 (週二)",
                 theme: "Aeon Mall 採購與返程",
                 items: [
                     { time: "09:00", title: "飯店退房", type: "stay", color: "cyan", icon: "door-open", desc: "東京灣東方飯店退房，將行李寄放至舞濱站置物櫃。", hasImage: false },
                     { time: "10:00", title: "Aeon Mall 永旺夢樂城", type: "shopping", color: "pink", icon: "shopping-cart", desc: "在 Aeon Mall 進行最後的伴手禮和生活用品採購。", note: "可在此解決午餐。", hasImage: false },
                     { time: "13:00", title: "午餐 (Aeon Mall 內)", type: "food", color: "orange", icon: "sandwich", desc: "在商場內用午餐。", hasImage: false },
                     { time: "15:00", title: "前往成田機場 (NRT T2)", type: "transport", color: "slate", icon: "bus", desc: "搭乘電車或巴士前往成田機場 T2。", note: "預留 3 小時的交通與報到時間。", hasImage: false },
                     { time: "16:00", title: "虎航 IT203 Check-in", type: "transport", color: "blue", icon: "luggage", desc: "辦理登機手續與托運行李。", note: "回程航班為 IT203 (18:25)。", hasImage: false },
                     { time: "18:25", title: "班機起飛 (NRT T2 to TPE T1)", type: "transport", color: "rose", icon: "plane", desc: "結束愉快的東京之旅，返回甜蜜的家。", hasImage: false }
                 ]
            }
        };

        // ----------------------------------------------------
        // 2. 核心功能邏輯
        // ----------------------------------------------------
        
        // 替換佔位圖片 URL (移到全域，供 renderTimeline 和 openModal 使用)
        function getPlaceholderImage(title) {
            const t = encodeURIComponent(title.substring(0, 10));
            return `https://placehold.co/600x338/e5e7eb/6b7280?text=${t}...`;
        }

        // --- 攜帶物品清單資料與狀態管理 ---
        const packingListData = [
            { id: 'passport', text: "護照、機票、日幣", checked: true }, 
            { id: 'adapter', text: "轉接頭與充電線", checked: false },
            { id: 'suica', text: "西瓜卡/Pasmo 卡", checked: false },
            { id: 'meds', text: "常備藥品 (感冒藥、腸胃藥)", checked: false },
            { id: 'layers', text: "防寒衣物與發熱衣", checked: false },
            { id: 'hotel_confirm', text: "飯店訂房確認信 (兩段住宿)", checked: false },
            { id: 'disney_ticket', text: "迪士尼門票 (1/15)", checked: false },
        ];

        function initializePackingList() {
            const storedList = localStorage.getItem('packingListState');
            if (storedList) {
                const storedItems = JSON.parse(storedList);
                packingListData.forEach(item => {
                    const storedItem = storedItems.find(s => s.id === item.id);
                    if (storedItem) {
                        item.checked = storedItem.checked;
                    }
                });
            }
            renderPackingList();
        }

        function savePackingListState() {
            localStorage.setItem('packingListState', JSON.stringify(packingListData));
            updatePackingListHeader();
        }

        window.togglePackingItem = function(id) {
            const item = packingListData.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                savePackingListState();
                renderPackingList(); 
            }
        }

        function updatePackingListHeader() {
            const checkedCount = packingListData.filter(item => item.checked).length;
            const totalCount = packingListData.length;
            const header = document.querySelector('#packing-list-header');
            if (header) {
                header.innerHTML = `<i data-lucide="list-todo" class="w-4 h-4 mr-1"></i>行前檢查清單 (${checkedCount}/${totalCount})`;
                lucide.createIcons();
            }
        }

        function renderPackingList() {
            const listElement = document.getElementById('packing-list');
            if (!listElement) return;

            listElement.innerHTML = packingListData.map(item => {
                const checkedClass = item.checked ? 'text-gray-400 line-through' : 'text-gray-800';
                const icon = item.checked ? 'check-square' : 'square';
                return `
                    <li class="flex items-center cursor-pointer active:scale-[0.99] transition-transform" 
                        onclick="togglePackingItem('${item.id}')">
                        <i data-lucide="${icon}" class="w-5 h-5 mr-3 text-green-500 shrink-0"></i>
                        <span class="text-sm font-medium ${checkedClass} select-none">${item.text}</span>
                    </li>
                `;
            }).join('');
            lucide.createIcons();
            updatePackingListHeader();
        }
        // ----------------------------------------------------


        let currentDay = 1;

        // 頁面切換核心邏輯
        window.renderPage = function(pageName) {
            const pages = {
                'home': document.getElementById('home-page'),
                'timeline': document.getElementById('timeline-page'),
            };
            const navItems = {
                'home': document.getElementById('nav-home'),
                'timeline': document.getElementById('nav-timeline'),
            };

            window.scrollTo({ top: 0, behavior: 'smooth' });

            Object.keys(pages).forEach(key => {
                const page = pages[key];
                const nav = navItems[key];
                
                page.classList.remove('active-page', 'animate-fade-in');
                
                if (key === pageName) {
                    page.classList.remove('hidden-page');
                    page.classList.add('active-page', 'animate-fade-in');
                    if (nav) {
                        nav.classList.add('text-gray-800', 'active-nav-item');
                        nav.classList.remove('text-gray-400', 'inactive-nav-item');
                    }
                    // 如果切換到行程頁面，重新渲染時間軸
                    if (pageName === 'timeline') {
                        renderTimeline(currentDay);
                    }
                } else {
                    page.classList.add('hidden-page');
                    if (nav) {
                        nav.classList.remove('text-gray-800', 'active-nav-item');
                        nav.classList.add('text-gray-400', 'inactive-nav-item');
                    }
                }
            });
        }


        // 渲染行程時間軸
        window.renderTimeline = function(day) {
            currentDay = day;
            const container = document.getElementById('timeline-container');
            const data = itineraryData[day];
            
            // 更新 Tab 樣式
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('bg-gray-800', 'text-white');
                tab.classList.add('bg-white', 'text-gray-400', 'border', 'border-gray-100');
            });
            const activeTab = document.getElementById(`tab-${day}`);
            activeTab.classList.remove('bg-white', 'text-gray-400', 'border', 'border-gray-100');
            activeTab.classList.add('bg-gray-800', 'text-white');

            // 標題與說明
            let html = `
                <div class="mb-6 pr-4 animate-fade-in text-center"> 
                    <p class="text-sm font-medium text-gray-400 mb-1">${data.date}</p>
                    <h3 class="text-2xl font-bold text-gray-800 tracking-wide">${data.theme}</h3>
                </div>
                <div class="relative space-y-4 pb-16"> <!-- 增加底部 padding 以取代被移除的圖表空間 -->
                    <div class="timeline-line"></div>
            `;

            // 迴圈生成每一個行程項目
            data.items.forEach((item, index) => {
                // 根據類型設定顏色變數 (Tailwind classes)
                const colorMap = {
                    'blue': { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100', dot: 'bg-blue-400' },
                    'slate': { bg: 'bg-slate-50', text: 'text-slate-600', border: 'border-slate-100', dot: 'bg-slate-400' },
                    'orange': { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100', dot: 'bg-orange-400' },
                    'pink': { bg: 'bg-pink-50', text: 'text-pink-600', border: 'border-pink-100', dot: 'bg-pink-400' },
                    'red': { bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-100', dot: 'bg-red-400' },
                    'indigo': { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-100', dot: 'bg-indigo-400' },
                    'yellow': { bg: 'bg-yellow-50', text: 'text-yellow-600', border: 'border-yellow-100', dot: 'bg-yellow-400' },
                    'green': { bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-100', dot: 'bg-green-400' },
                    'sky': { bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-100', dot: 'bg-sky-400' },
                    'purple': { bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-100', dot: 'bg-purple-400' },
                    'cyan': { bg: 'bg-cyan-50', text: 'text-cyan-600', border: 'border-cyan-100', dot: 'bg-cyan-400' },
                    'amber': { bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-100', dot: 'bg-amber-400' },
                    'default': { bg: 'bg-gray-50', text: 'text-gray-600', border: 'border-gray-100', dot: 'bg-gray-400' }
                };
                const colors = colorMap[item.color] || colorMap['default'];
                
                // 將 item 資料轉為 JSON 字串，以便 onclick 傳遞
                const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');

                // 新增：圖片區塊 HTML
                const imageBlockHtml = item.hasImage && item.image
                    ? `
                        <div class="mt-2 mb-2">
                            <img src="${item.image}" class="w-full aspect-[16/9] object-cover rounded-lg shadow-sm" 
                                alt="${item.title}" 
                                onerror="this.onerror=null; this.src='${getPlaceholderImage(item.title)}';">
                        </div>
                      `
                    : '';

                html += `
                    <div class="relative pl-10 pr-4 animate-slide-up" style="animation-delay: ${index * 0.05}s" onclick="openModal(${itemJson})">
                        <!-- 時間點 (Dot) -->
                        <div class="absolute left-[1.25rem] -translate-x-1/2 w-4 h-4 rounded-full border-2 border-white shadow-sm ${colors.dot} z-10"></div>
                        
                        <!-- 卡片本體 -->
                        <div class="app-card interactive p-4 border ${colors.border} ${colors.bg} cursor-pointer">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm font-bold text-gray-400 tracking-wide font-mono">${item.time}</span>
                                <i data-lucide="${item.icon}" class="w-4 h-4 ${colors.text} opacity-70"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg leading-tight mb-1">${item.title}</h4>
                            
                            <!-- 內嵌圖片 (若有) -->
                            ${imageBlockHtml} 

                            <!-- 描述 -->
                            <p class="text-sm text-gray-500 line-clamp-2">${item.desc}</p>
                        </div>
                    </div>
                `;
            });

            html += `</div>`; // Close container
            container.innerHTML = html;
            
            // 重新渲染 icons
            lucide.createIcons();
            
            // 圖表相關的邏輯已移除
        }


        // 開啟 Modal (詳細資訊彈窗)
        window.openModal = function(item) {
            const modal = document.getElementById('detail-modal');
            const body = document.getElementById('modal-dynamic-body');
            
            // 決定 Modal 內容樣式
            let contentHtml = '';

            // 輔助函式：渲染備註區塊
            function renderNote(item) {
                if (!item.note) return '';
                return `
                    <div class="flex items-start p-3 bg-yellow-50 rounded-xl border border-yellow-100/50">
                        <i data-lucide="sticky-note" class="w-4 h-4 text-yellow-500 mt-0.5 mr-2 shrink-0"></i>
                        <p class="text-sm text-yellow-700 leading-relaxed font-medium">${item.note}</p>
                    </div>
                `;
            }

            const colorMap = {
                'blue': 'blue', 'slate': 'slate', 'orange': 'orange', 'pink': 'pink', 'red': 'red', 
                'indigo': 'indigo', 'yellow': 'yellow', 'green': 'green', 'sky': 'sky', 
                'purple': 'purple', 'cyan': 'cyan', 'amber': 'amber', 'default': 'gray'
            };
            const colorName = colorMap[item.color] || colorMap['default'];

            // --- 地圖按鈕生成邏輯 ---
            let mapButtonHtml;
            const mapLink = item.mapLink;
            const buttonText = mapLink ? '地圖導航 (點擊連結)' : '地圖導航 (連結待定)';
            const buttonIcon = mapLink ? 'map' : 'map';
            
            if (mapLink) {
                // 啟用狀態：黑底白字，有互動效果
                mapButtonHtml = `
                    <button class="flex-1 py-3 bg-gray-900 text-white rounded-xl text-sm font-bold flex items-center justify-center space-x-2 active:scale-[0.99] transition-transform" onclick="window.open('${mapLink}', '_blank')">
                        <i data-lucide="${buttonIcon}" class="w-4 h-4"></i>
                        <span>${buttonText}</span>
                    </button>
                `;
            } else {
                // 禁用狀態：灰底灰字，無點擊或 hover 效果
                mapButtonHtml = `
                    <button class="flex-1 py-3 bg-gray-200 text-gray-400 rounded-xl text-sm font-bold flex items-center justify-center space-x-2 cursor-not-allowed" disabled>
                        <i data-lucide="${buttonIcon}" class="w-4 h-4"></i>
                        <span>${buttonText}</span>
                    </button>
                `;
            }


            if (item.hasImage) {
                // --- 樣式 A: 有圖片 (主要景點) ---
                contentHtml = `
                    <div class="relative mb-5">
                        <img src="${item.image || getPlaceholderImage(item.title)}" class="aspect-[16/9] object-cover w-full rounded-2xl shadow-lg" alt="${item.title}" 
                             onerror="this.onerror=null; this.src='${getPlaceholderImage(item.title)}';">
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-sm font-bold text-gray-600 shadow-sm">
                            ${item.time}
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm font-bold text-${colorName}-500 uppercase tracking-wider mb-1 block">${item.type}</span>
                            <h2 class="text-3xl font-bold text-gray-800 leading-tight">${item.title}</h2>
                        </div>
                        <p class="text-base text-gray-600 leading-relaxed">
                            ${item.desc}
                        </p>
                        ${renderNote(item)}
                        <!-- 地圖導航按鈕 (樣式 A) -->
                        <div class="flex space-x-3 mt-4">
                            ${mapButtonHtml}
                        </div>
                    </div>
                `;
            } else {
                // --- 樣式 B: 無圖片 (一般行程) ---
                // 針對 Style B 的按鈕樣式進行調整，使用不同的按鈕文字和 Icon
                const buttonTextB = mapLink ? '查看位置 (點擊連結)' : '查看位置 (連結待定)';
                const buttonIconB = 'map-pin';

                let mapButtonHtmlB;
                if (mapLink) {
                    // 啟用狀態：使用主題色，有互動效果
                    mapButtonHtmlB = `
                        <button class="w-full py-3 border border-${colorName}-500 bg-${colorName}-50 text-${colorName}-700 rounded-xl text-sm font-bold flex items-center justify-center space-x-2 hover:bg-${colorName}-100 active:scale-[0.99] transition-transform" onclick="window.open('${mapLink}', '_blank')">
                            <i data-lucide="${buttonIconB}" class="w-4 h-4"></i>
                            <span>${buttonTextB}</span>
                        </button>
                    `;
                } else {
                    // 禁用狀態：灰底灰字，無點擊或 hover 效果
                    mapButtonHtmlB = `
                        <button class="w-full py-3 border border-gray-200 text-gray-400 rounded-xl text-sm font-bold flex items-center justify-center space-x-2 cursor-not-allowed bg-gray-100" disabled>
                            <i data-lucide="${buttonIconB}" class="w-4 h-4"></i>
                            <span>${buttonTextB}</span>
                        </button>
                    `;
                }

                contentHtml = `
                    <div class="flex items-start space-x-4 mb-6">
                        <div class="w-16 h-16 rounded-2xl bg-${colorName}-100 flex items-center justify-center shrink-0">
                            <i data-lucide="${item.icon}" class="w-8 h-8 text-${colorName}-600"></i>
                        </div>
                        <div>
                            <span class="text-sm font-bold text-gray-400 font-mono bg-gray-100 px-2 py-0.5 rounded">${item.time}</span>
                            <h2 class="text-2xl font-bold text-gray-800 mt-1">${item.title}</h2>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <p class="text-base text-gray-600 leading-relaxed">${item.desc}</p>
                        </div>
                        ${renderNote(item)}
                        <!-- 地圖導航按鈕 (樣式 B) -->
                        ${mapButtonHtmlB}
                    </div>
                `;
            }

            body.innerHTML = contentHtml;
            lucide.createIcons();
            document.body.classList.add('modal-active');
        }

        window.closeModal = function() {
            document.body.classList.remove('modal-active');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // 確保初始狀態：預設只顯示 Home Page
            renderPage('home'); 
            
            // 預先渲染 Day 1 的 Timeline
            renderTimeline(1);
            
            // NEW: 初始化打包清單
            initializePackingList();
        });
    </script>
</body>
</html>
